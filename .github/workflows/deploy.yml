name: Auto Update Version and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "xialongxl"
          git config --global user.email "xialong2001@gmail.com"

      - name: Generate timestamp version
        run: |
          # 生成毫秒级时间戳 (格式: 20240315123045999)
          VERSION=$(date +%Y%m%d%H%M%S%3N)
          echo "新版本号: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update files
        run: |
          # 1. 更新index.html
          sed -i "s/\(src=['\"][^'\"]*\.js\)?v=[^'\"]*/\1?v=$VERSION/g" index.html
          sed -i "s/\(href=['\"][^'\"]*\.css\)?v=[^'\"]*/\1?v=$VERSION/g" index.html

          # 2. 更新rpgCore.js (数字格式)
          sed -i "s/\(version:\)[0-9.]\+/\1$VERSION/g" rpgCore.js

          # 3. 更新saveSystem.js (字符串格式)
          sed -i "s/\(const VERSION = '\)[^']*\('\)/\1$VERSION\2/g" saveSystem.js

      - name: Commit changes
        run: |
          git add index.html rpgCore.js saveSystem.js
          git diff --staged --quiet || git commit -m "Auto update version to $(date +%Y%m%d%H%M%S%3N)"
          git push origin main

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # 🚨 必须保留（自动注入的token）
          publish_dir: ./           # ⚠️ 确认是包含index.html的目录
          force_orphan: true        # 🚨 建议true（清理旧文件）