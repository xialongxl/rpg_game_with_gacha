name: Auto Update Version and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "xialongxl"
          git config --global user.email "xialong2001@gmail.com"

      - name: Generate timestamp version
        run: |
          # ç”Ÿæˆæ¯«ç§’çº§æ—¶é—´æˆ³ (æ ¼å¼: 20240315123045999)
          VERSION=$(date +%Y%m%d%H%M%S%3N)
          echo "æ–°ç‰ˆæœ¬å·: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update files
        run: |
          # 1. æ›´æ–°index.htmlä¸­çš„å¼•ç”¨
          sed -i "s/\(src=['\"][^'\"]*\.js\)?v=[^'\"]*/\1?v=$VERSION/g" index.html
          sed -i "s/\(href=['\"][^'\"]*\.css\)?v=[^'\"]*/\1?v=$VERSION/g" index.html

          # 2. æ›´æ–°js/rpgCore.jsä¸­çš„ç‰ˆæœ¬å·ï¼ˆæ•°å­—æ ¼å¼ï¼‰
          sed -i "s/\(version:\)[0-9.]\+/\1$VERSION/g" js/rpgCore.js

          # 3. æ›´æ–°js/saveSystem.jsä¸­çš„ç‰ˆæœ¬å·ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
          sed -i "s/\(const VERSION = '\)[^']*\('\)/\1$VERSION\2/g" js/saveSystem.js

          # éªŒè¯ä¿®æ”¹
          echo "=== ä¿®æ”¹ç»“æœéªŒè¯ ==="
          grep -E "\.(js|css)\?v=" index.html
          grep "version:" js/rpgCore.js
          grep "const VERSION =" js/saveSystem.js

      - name: Commit changes
        run: |
          git add index.html js/rpgCore.js js/saveSystem.js
          git diff --staged --quiet || git commit -m "Auto update version to $(date +%Y%m%d%H%M%S%3N)"
          git push origin main

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # ğŸš¨ å¿…é¡»ä¿ç•™ï¼ˆè‡ªåŠ¨æ³¨å…¥çš„tokenï¼‰
          publish_dir: ./           # âš ï¸ ç¡®è®¤æ˜¯åŒ…å«index.htmlçš„ç›®å½•
          force_orphan: true        # ğŸš¨ å»ºè®®trueï¼ˆæ¸…ç†æ—§æ–‡ä»¶ï¼‰