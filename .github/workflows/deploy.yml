name: Auto Update Version and Deploy

on:
  push:
    branches: [ "main" ]  # âš ï¸ ç¡®ä¿è¿™æ˜¯ä½ çš„å®é™…åˆ†æ”¯åï¼ˆå¯èƒ½æ˜¯main/masterï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ğŸš¨ å¿…é¡»ä¿ç•™ï¼ˆå†™å…¥æƒé™ï¼‰
      pages: write     # ğŸš¨ å¿…é¡»ä¿ç•™ï¼ˆPageséƒ¨ç½²æƒé™ï¼‰
      id-token: write  # ğŸš¨ å¿…é¡»ä¿ç•™ï¼ˆè®¤è¯æƒé™ï¼‰

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          persist-credentials: true  # ğŸš¨ å¿…é¡»ä¸ºtrueï¼ˆå¦åˆ™æ— æ³•æ¨é€ï¼‰
          fetch-depth: 0            # âš ï¸ å»ºè®®ä¿ç•™ï¼ˆè·å–å®Œæ•´gitå†å²ï¼‰

      # æ­¥éª¤2ï¼šé…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: Setup Git
        run: |
          git config --global user.name "xialongxl"  # ğŸš¨ å¿…é¡»å¡«å†™ï¼ˆä»»æ„éç©ºå­—ç¬¦ä¸²ï¼‰
          git config --global user.email "xialong2001@gmail.com"  # ğŸš¨ å¿…é¡»å¡«å†™ï¼ˆæ ¼å¼æ­£ç¡®é‚®ç®±ï¼‰

      # æ­¥éª¤3ï¼šç‰ˆæœ¬æ›¿æ¢é€»è¾‘
      - name: Update version in HTML
        run: |
          GIT_HASH=$(git rev-parse --short HEAD)
          # ğŸš¨ æ£€æŸ¥ä»¥ä¸‹sedå‘½ä»¤æ˜¯å¦åŒ¹é…ä½ çš„HTMLæ–‡ä»¶æ ¼å¼ï¼š
          # å¦‚æœç”¨çš„æ˜¯å•å¼•å·ï¼ˆsrc='...'ï¼‰ï¼Œéœ€è¦è°ƒæ•´æ­£åˆ™è¡¨è¾¾å¼
          sed -i "s/\(src=['\"][^'\"]*\.js\)?v=[^'\"]*/\1?v=$GIT_HASH/g" index.html
          sed -i "s/\(href=['\"][^'\"]*\.css\)?v=[^'\"]*/\1?v=$GIT_HASH/g" index.html

      # æ­¥éª¤4ï¼šæäº¤æ›´æ”¹
      - name: Commit and Push changes
        run: |
          git add index.html
          # ğŸš¨ å¦‚æœä½¿ç”¨ä¿æŠ¤åˆ†æ”¯ï¼Œå¯èƒ½éœ€è¦å¼ºåˆ¶æ¨é€ï¼ˆåŠ -fï¼‰
          git diff --staged --quiet || git commit -m "Auto update version to $(git rev-parse --short HEAD)"
          git push origin main  # âš ï¸ ç¡®ä¿åˆ†æ”¯åä¸on.push.branchesä¸€è‡´

      # æ­¥éª¤5ï¼šéƒ¨ç½²åˆ°GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # ğŸš¨ å¿…é¡»ä¿ç•™ï¼ˆè‡ªåŠ¨æ³¨å…¥çš„tokenï¼‰
          publish_dir: ./           # âš ï¸ ç¡®è®¤æ˜¯åŒ…å«index.htmlçš„ç›®å½•
          force_orphan: true        # ğŸš¨ å»ºè®®trueï¼ˆæ¸…ç†æ—§æ–‡ä»¶ï¼‰